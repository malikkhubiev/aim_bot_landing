const API_BASE = 'https://aim-pay-bot-server.onrender.com';

function getLeadId() {
  const url = new URL(window.location.href);
  return url.searchParams.get('lead_id');
}

async function sendProgress(step, answer) {
  const leadId = getLeadId();
  if (!leadId) return;
  try {
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º step_index –∏–∑ step (final_q1 -> 0, final_q2 -> 1, final_q3 -> 2)
    let stepIndex = null;
    let stepKey = step;
    if (step.startsWith('final_q')) {
      const match = step.match(/final_q(\d+)/);
      if (match) {
        stepIndex = parseInt(match[1]) - 1; // step_index –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å 0
        stepKey = step;
      }
    }
    
    const response = await fetch(`${API_BASE}/form_warm/clients/${leadId}/progress`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ 
        stage: 'final',
        step: stepKey,
        step_index: stepIndex,
        answer: typeof answer === 'object' ? JSON.stringify(answer) : answer 
      })
    });
    // –ï—Å–ª–∏ –æ—Ç–≤–µ—Ç —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –æ–±–Ω–æ–≤–ª—è–µ–º –µ–≥–æ
    if (!response.ok && response.status !== 200) {
      await fetch(`${API_BASE}/form_warm/clients/${leadId}/answers`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ step: stepKey, answer: typeof answer === 'object' ? JSON.stringify(answer) : answer })
      });
    }
  } catch (_) {}
}

// –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã
let savedAnswers = {};
async function loadSavedAnswers() {
  const leadId = getLeadId();
  if (!leadId) return;
  try {
    const resp = await fetch(`${API_BASE}/form_warm/clients/${leadId}/progress`);
    const data = await resp.json();
    if (data.status === 'success' && data.progress) {
      data.progress.forEach(p => {
        savedAnswers[p.step] = p.answer;
      });
    }
  } catch (_) {}
}

const quizData = [
  {
    type: 'choice',
    title: '–í–æ–ø—Ä–æ—Å 1: –¢—ã —Å–º–æ—Ç—Ä–∏—à—å –æ–±—É—á–∞—é—â–µ–µ –≤–∏–¥–µ–æ. –ö–∞–∫–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ ‚Äî —Ç–≤–æ—è —Å—Ç–∏—Ö–∏—è üåä?',
    options: [
      {
        answer: '–∞) ¬´–¢—É—Ä–±–æ-—Ä–µ–∂–∏–º üöÄ!¬ª x1.25 | x1.5 | x2',
        description: "–ú–æ–π –º–æ–∑–≥ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –æ–±–æ—Ä–æ—Ç–∞—Ö üèéÔ∏èüß†!<br>–ú–Ω–µ —Å–∫—É—á–Ω–æ —Å–ª—É—à–∞—Ç—å –º–µ–¥–ª–µ–Ω–Ω—É—é –∏ –≤–æ–¥—É üí¶.<br>–õ–µ–∫—Ç–æ—Ä—ã —á–∞—Å—Ç–æ —Ä–∞—Å—Ç—è–≥–∏–≤–∞—é—Ç –ø—Ä–æ—Å—Ç—ã–µ –º—ã—Å–ª–∏ ‚Äî –º–Ω–µ –Ω–µ–∫–æ–≥–¥–∞ ‚è≥!<br>–í—Ä—É–±–∞—é —É—Å–∫–æ—Ä–µ–Ω–∏–µ, –ª–æ–≤–ª—é —Å—É—Ç—å –∏ –ª–µ—á—É –¥–∞–ª—å—à–µ ‚Äî –∫ —Ä–µ–∞–ª—å–Ω—ã–º –¥–µ–π—Å—Ç–≤–∏—è–º üí™!"
      },
      {
        answer: '–±) ¬´–û—Å–Ω–æ–≤–∞—Ç–µ–ª—å–Ω—ã–π –ò—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å üßê¬ª –û–±—ã—á–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å (x1.0)',
        description: "–Ø –Ω–µ –≥–æ–Ω—é—Å—å –∑–∞ —Å–∫–æ—Ä–æ—Å—Ç—å—é.<br>–ú–Ω–µ –≤–∞–∂–Ω–æ –≤–Ω–∏–∫–Ω—É—Ç—å –≤ –∫–∞–∂–¥—É—é –¥–µ—Ç–∞–ª—å–∫—É, —É–ª–æ–≤–∏—Ç—å –∫–∞–∂–¥—É—é –Ω—é–∞–Ω—Å–Ω—É—é –º—ã—Å–ª—å üß†.<br>–ü—É—Å—Ç—å –º–µ–¥–ª–µ–Ω–Ω–µ–µ, –∑–∞—Ç–æ —è –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –ü–û–ù–Ø–õ –º–∞—Ç–µ—Ä–∏–∞–ª üëå, –∞ –Ω–µ –ø—Ä–æ—Å—Ç–æ ¬´–ø—Ä–æ—à—ë–ª¬ª –µ–≥–æ.<br>–ú–Ω–µ –Ω—Ä–∞–≤–∏—Ç—Å—è —á—É–≤—Å—Ç–≤–æ–≤–∞—Ç—å, –∫–∞–∫ –∑–Ω–∞–Ω–∏—è —É–∫–ª–∞–¥—ã–≤–∞—é—Ç—Å—è –ø–æ –ø–æ–ª–æ—á–∫–∞–º üßë‚Äçüéì!"
      },
      {
        answer: '–≤) ¬´–õ–æ–≤–µ—Ü –•–∞–π–ø–∞ ‚ú®¬ª –ú–µ–Ω—è –¥–æ–ª–∂–Ω–æ –∑–∞—Ü–µ–ø–∏—Ç—å —Å –ø–µ—Ä–≤—ã—Ö —Å–µ–∫—É–Ω–¥!',
        description: "–ü–µ—Ä–≤—ã–µ 10 —Å–µ–∫—É–Ω–¥ ‚Äî –∏ —è —Ä–µ—à–∞—é, –º–æ–µ –∏–ª–∏ –Ω–µ—Ç.<br>–ï—Å–ª–∏ –Ω–µ—Ç –≤–∞—É-—ç—Ñ—Ñ–µ–∫—Ç–∞ ü§Ø, –∏–Ω—Ç—Ä–∏–≥–∏ –∏–ª–∏ —é–º–æ—Ä–∞ ü§£ ‚Äî –º–Ω–µ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è —Å–∫—É—á–Ω–æ ‚ùå.<br>–ü—Ä–æ—â–µ –Ω–∞–π—Ç–∏ –¥—Ä—É–≥–æ–µ –≤–∏–¥–µ–æ –∏–ª–∏ –∑–∞–Ω—è—Ç–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ —Å—Ä–∞–∑—É –ø–æ–¥–∞—Ä–∏—Ç –∑–∞—Ä—è–¥ —ç–Ω–µ—Ä–≥–∏–∏!<br>–í—Ä–µ–º—è –¥–æ—Ä–æ–≥–æ üí∏, —Ç—Ä–∞—Ç–∏—Ç—å –µ–≥–æ –Ω–∞ —Å–∫—É–∫—É ‚Äî –Ω–µ –¥–ª—è –º–µ–Ω—è!"
      },
    ],
    scores: { '–∞': 3, '–±': 2, '–≤': 1 }
  },
  {
    type: 'choice',
    title: '–í–æ–ø—Ä–æ—Å 2: –ü—Ä–µ–¥—Å—Ç–∞–≤—å, —Ç—ã –≤ –≥–∞—Ä–∞–∂–µ, –∞ –ø–µ—Ä–µ–¥ —Ç–æ–±–æ–π ‚Äî –Ω–æ–≤–µ–Ω—å–∫–∞—è, –æ–≥–Ω–µ–Ω–Ω–∞—è Lamborghini! üî• –†—è–¥–æ–º ‚Äî –±–ª–µ—Å—Ç—è—â–∏–π –Ω–∞–±–æ—Ä –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤. –†—É–∫–∏ —Ç–∞–∫ –∏ —á–µ—à—É—Ç—Å—è! –ß—Ç–æ –±—É–¥–µ—à—å –¥–µ–ª–∞—Ç—å?',
    options: [
      {
        answer: '–∞) –Ø ‚Äî –ò–Ω–∂–µ–Ω–µ—Ä –ë—É–¥—É—â–µ–≥–æ üöÄ!',
        description: "–°–Ω–∞—á–∞–ª–∞ —Å–∞–∂—É—Å—å –≤ —Å–∞–ª–æ–Ω ‚Äî —Ç—Ä–æ–≥–∞—é —Ä—É–ª—å, –∏–∑—É—á–∞—é –∫–∞–∂–¥—É—é –∫–Ω–æ–ø–∫—É üßê. –í –≥–æ–ª–æ–≤–µ —É–∂–µ —Å—Ç—Ä–æ—é –¥–æ–≥–∞–¥–∫–∏: ¬´–ò –∫–∞–∫ –¢–ê–ö–û–ï —Å–æ–±—Ä–∞–ª–∏ ü§Ø?ÔºÅ<br>–ü–æ—Ç–æ–º –ª–µ–∑—É –ø–æ–¥ –∫–∞–ø–æ—Ç —Å –æ–¥–Ω–∏–º –∂–µ–ª–∞–Ω–∏–µ–º ‚Äî —Ä–∞–∑–æ–±—Ä–∞—Ç—å –í–°–Å –¥–æ –≤–∏–Ω—Ç–∏–∫–∞, –ø–æ–Ω—è—Ç—å –∫–∞–∂–¥—ã–π –º–µ—Ö–∞–Ω–∏–∑–º –∏ —Å–Ω–æ–≤–∞ —Å–æ–±—Ä–∞—Ç—å –≤ –µ–¥–∏–Ω—É—é, –≥–µ–Ω–∏–∞–ª—å–Ω—É—é —Å–∏—Å—Ç–µ–º—É ‚ù§Ô∏è‚Äçüî•! <br>–ú–Ω–µ –≤–∞–∂–Ω–æ –Ω–µ –ø—Ä–æ—Å—Ç–æ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å üëÅÔ∏è, –∞ –ø–æ–Ω—è—Ç—å —Å–∞–º—É—é —Å—É—Ç—å üß†."
      },
      {
        answer: '–±) –Ø ‚Äî –í–∑—Ä—ã–≤–Ω–æ–π –≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞—Ç–æ—Ä ü§©!',
        description: "–û –¥–∞! –ö–∞–ø–æ—Ç ‚Äî –¥–æ–ª–æ–π! –í–∏–∂—É —ç—Ç–æ—Ç –ª–∞–±–∏—Ä–∏–Ω—Ç –∏–∑ —Ç—Ä—É–±–æ–∫ –∏ –ø—Ä–æ–≤–æ–¥–æ–≤ ‚Äî –∏ —Å—Ä–∞–∑—É –≤ –±–æ–π ‚öîÔ∏è! –ù–∞—á–∏–Ω–∞—é –æ—Ç–∫—Ä—É—á–∏–≤–∞—Ç—å —Ç–æ, —á—Ç–æ –ø—Ä–æ—â–µ. –ü–æ–ª—É—á–∞–µ—Ç—Å—è ‚Äî –≤–æ—Å—Ç–æ—Ä–≥ üî•!<br>–ù–æ –≤–æ—Ç... –¥–µ—Ç–∞–ª–µ–π –º–Ω–æ–≥–æ, —è —É–≤–ª—ë–∫—Å—è, –æ—Ç–≤–ª—ë–∫—Å—è –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —Ç–µ–ª–µ—Ñ–æ–Ω–µ... –∏ —Ç—É—Ç –æ—Å–æ–∑–Ω–∞—é, —á—Ç–æ –∑–∞–±—ã–ª, —á—Ç–æ –∫—É–¥–∞ –∫—Ä–µ–ø–∏–ª–æ—Å—å üòÖ.<br>–õ–∞–¥–Ω–æ, —Ö–≤–∞—Ç–∏—Ç –∏–≥—Ä! –ü–æ–π–¥—É-–∫–∞ —è –ª—É—á—à–µ –≤ —Å–∞–ª–æ–Ω–µ –ø–æ—Å–∏–∂—É, –ø–æ–º–µ—á—Ç–∞—é –æ –≥–æ–Ω–∫–∞—Ö üèÅ.<br>–ì–ª–∞–≤–Ω–æ–µ ‚Äî –ø–æ–ø—Ä–æ–±–æ–≤–∞–ª!"
      },
      {
        answer: '–≤) –Ø ‚Äî –û—Å—Ç–æ—Ä–æ–∂–Ω—ã–π –ù–∞–±–ª—é–¥–∞—Ç–µ–ª—å ü´£.',
        description: "–ü–æ–¥ –∫–∞–ø–æ—Ç? –ù–∏ –∑–∞ —á—Ç–æ! –¢–∞–º –∂–µ –≤—Å—ë —Ç–∞–∫–æ–µ —Ö—Ä—É–ø–∫–æ–µ –∏ –¥–æ—Ä–æ–≥–æ–µ üí∏...<br>–ó–∞—á–µ–º —Ä–∏—Å–∫–æ–≤–∞—Ç—å? –Ø –ª—É—á—à–µ –ø—Ä–æ–π–¥—É—Å—å –≤–æ–∫—Ä—É–≥ —ç—Ç–æ–≥–æ —à–µ–¥–µ–≤—Ä–∞ üé®, –ø–æ—Å—á–∏—Ç–∞—é, —Å–∫–æ–ª—å–∫–æ —à–∞–≥–æ–≤ –æ–Ω –∑–∞–Ω–∏–º–∞–µ—Ç, —Å—Ñ–æ—Ç–∫–∞—é –¥–ª—è –∏–Ω—Å—Ç—ã üì∏.<br>–ó–∞—á–µ–º –∑–∞–±–∏–≤–∞—Ç—å –≥–æ–ª–æ–≤—É, –ö–ê–ö –æ–Ω–∞ –µ–¥–µ—Ç?<br>–ì–ª–∞–≤–Ω–æ–µ ‚Äî —á—Ç–æ –æ–Ω–∞ –µ—Å—Ç—å –∏ –æ–Ω–∞ –∫—Ä–∞—Å–∏–≤–∞—è üòÑ!"
      },
    ],
    scores: { '–∞': 3, '–±': 2, '–≤': 1 }
  },
  {
    type: 'choice',
    title: '–í–æ–ø—Ä–æ—Å 3: –ü–æ—á–µ–º—É —Ç—ã –≤–æ–æ–±—â–µ —Ö–æ—á–µ—à—å —É—á–∏—Ç—å—Å—è Machine Learning üß†‚ú®?',
    options: [
      {
        answer: '–∞) –ú–Ω–µ –ò–ù–¢–ï–†–ï–°–ù–û, –∫–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —ç—Ç–∞ –º–∞–≥–∏—è ü™Ñ.',
        description: "–•–æ—á—É –Ω–µ –ø—Ä–æ—Å—Ç–æ –∫–Ω–æ–ø–∫–∏ –Ω–∞–∂–∏–º–∞—Ç—å, –∞ –ø–æ–Ω—è—Ç—å —Å–∞–º—É –∏–¥–µ—é, —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è –≤ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞—Ö –∏ –ø—Ä–æ–∫–∞—á–∞—Ç—å —Å–≤–æ–π –º–æ–∑–≥ –¥–æ —É—Ä–æ–≤–Ω—è —Å—É–ø–µ—Ä–≥–µ—Ä–æ—è ‚òÑÔ∏è!<br>–ï—Å–ª–∏ –≤—Ç—è–Ω—É—Å—å ‚Äî –≥–æ—Ç–æ–≤ –≥—Ä—ã–∑—Ç—å –≥—Ä–∞–Ω–∏—Ç –Ω–∞—É–∫–∏ –≥–æ–¥–∞–º–∏, —á—Ç–æ–±—ã —á–µ—Ä–µ–∑ –ø–∞—Ä—É –ª–µ—Ç —Å—Ç–∞—Ç—å —Ç–µ–º —Å–∞–º—ã–º –≥—É—Ä—É, –∫–æ—Ç–æ—Ä—ã–π –¥–≤–∏–≥–∞–µ—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å –≤–ø–µ—Ä—ë–¥ üî•!"
      },
      {
        answer: '–±) –Ø - ¬´–ü—Ä–∞–≥–º–∞—Ç–∏—á–Ω—ã–π –°—Ç—Ä–∞—Ç–µ–≥¬ª üíºüí∏',
        description: "–°–º–æ—Ç—Ä—é –Ω–∞ —Ä—ã–Ω–æ–∫ ‚Äî —Ç—É—Ç –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–Ω–æ üî•, –¥–∞ –∏ –∑–∞—Ä–ø–ª–∞—Ç—ã –∫—É—Å–∞—é—Ç—Å—è.<br>–ó–Ω–∞—á–∏—Ç, –ù–ê–î–û –æ—Å–≤–∞–∏–≤–∞—Ç—å!<br>–•–æ—á—É –±—ã—Ç—å –≤ —Ç—Ä–µ–Ω–¥–µ, –∞ –Ω–µ –Ω–∞ –æ–±–æ—á–∏–Ω–µ. IT ‚Äî —ç—Ç–æ –¥–µ–Ω–µ–∂–Ω–æ, –∞ —è –Ω–µ –ø—Ä–æ—Ç–∏–≤ —É–≤–µ–ª–∏—á–∏—Ç—å —Å–≤–æ–π –¥–æ—Ö–æ–¥ üí∞.<br>–ë—É–¥–µ—Ç —Å–ª–æ–∂–Ω–æ? –ù–æ –∫—Ç–æ —Å–∫–∞–∑–∞–ª, —á—Ç–æ –¥–µ–Ω—å–≥–∏ –¥–∞—é—Ç—Å—è –ª–µ–≥–∫–æ? üí∏"
      },
      {
        answer: '–≤) ¬´–ò—Å–∫–∞—Ç–µ–ª—å –ü—É—Ç–∏¬ª üó∫Ô∏èüòµ',
        description: "–ß–µ—Å—Ç–Ω–æ? –Ø –Ω–µ–º–Ω–æ–≥–æ –≤ —Ç—É–º–∞–Ω–µ üí®...<br>–í—Ä–æ–¥–µ —Ö–æ—á—É —Ä–∞–∑–≤–∏–≤–∞—Ç—å—Å—è, –Ω–æ –Ω–µ –∑–Ω–∞—é, –∑–∞ —á—Ç–æ —É—Ö–≤–∞—Ç–∏—Ç—å—Å—è.<br>–ù–∞–¥–µ—é—Å—å, —á—Ç–æ –∑–∞–ø–ª–∞—á—É –∑–∞ –∫—É—Ä—Å ‚Äî –∏ –º–µ–Ω—è –≤–æ–∑—å–º—É—Ç –∑–∞ —Ä—É—á–∫—É ü§ù, –ø–æ–≤–µ–¥—É—Ç –∫ —Å–≤–µ—Ç–ª–æ–º—É –±—É–¥—É—â–µ–º—É üåå, –≥–¥–µ —è –Ω–∞–∫–æ–Ω–µ—Ü-—Ç–æ –Ω–∞—á–Ω—É –ø—Ä–∏–Ω–∏–º–∞—Ç—å —É–º–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è üß†, –∞ –Ω–µ –º–µ—Ç–∞—Ç—å—Å—è.<br>–ú–æ–∂–µ—Ç, —Ö–æ—Ç—å —ç—Ç–æ –≤—ã–≤–µ–¥–µ—Ç –º–µ–Ω—è –∫ –¥–µ–Ω—å–≥–∞–º –∏ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏... ü§∑‚Äç‚ôÇÔ∏è"
      },
    ],
    scores: { '–∞': 3, '–±': 2, '–≤': 1 }
  }
];

function calculateScore(answers) {
  let total = 0;
  answers.forEach((answer, idx) => {
    if (answer && quizData[idx]) {
      const firstChar = answer.answer.charAt(0).toLowerCase();
      total += quizData[idx].scores[firstChar] || 0;
    }
  });
  return total;
}

function getVerdict(score) {
  if (score >= 7 && score <= 9) {
    return {
      title: '–í–µ—Ä–¥–∏–∫—Ç 1: ¬´–ê—Ä—Ö–∏—Ç–µ–∫—Ç–æ—Ä –±—É–¥—É—â–µ–≥–æ üöÄ¬ª (7-9 –±–∞–ª–ª–æ–≤)',
      subtitle: '<b>–ë—Ä–∞–≤–æ!<br>–¢—ã —Ç–æ—Ç, —Ä–∞–¥–∏ –∫–æ–≥–æ –º—ã —Å–æ–∑–¥–∞–≤–∞–ª–∏ —ç—Ç–æ—Ç –∫—É—Ä—Å!</b><br>–ù–∞—à–µ —Å–µ—Ä–¥—Ü–µ –±—å–µ—Ç—Å—è —á–∞—â–µ, –∫–æ–≥–¥–∞ –º—ã –≤—Å—Ç—Ä–µ—á–∞–µ–º —Ç–∞–∫–∏—Ö —Ü–µ–ª–µ—É—Å—Ç—Ä–µ–º–ª–µ–Ω–Ω—ã—Ö –ª—é–¥–µ–π ‚ù§Ô∏è‚Äçüî•',
      content: `
        <p><strong>–¢–≤–æ–π –ø–æ—Ä—Ç—Ä–µ—Ç:</strong> –¢—ã –ª—é–±–æ–∑–Ω–∞—Ç–µ–ª–µ–Ω –¥–æ –≥–ª—É–±–∏–Ω—ã –¥—É—à–∏.<br>–¢–µ–±—è –∂–∂–µ—Ç –∏–∑–Ω—É—Ç—Ä–∏ –∂–µ–ª–∞–Ω–∏–µ –¥–æ–∫–æ–ø–∞—Ç—å—Å—è –¥–æ —Å—É—Ç–∏ üî•!<br>–¢—ã –ø—ã—Ç–∞–µ—à—å—Å—è –ø–æ–Ω—è—Ç—å —Å—É—Ç—å –≥–ª—É–±–æ–∫–æ, –∞ —Ç–≤–æ–π –º–æ–∑–≥ —Ç—Ä–µ–±—É–µ—Ç —Å–∫–æ—Ä–æ—Å—Ç–∏ –∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ üí™üß†.<br>–¢—ã —Å–º–æ—Ç—Ä–∏—à—å –≤ –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω—É—é –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤—É ‚Äî <b>—Å—Ç–∞—Ç—å –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª–æ–º –≠–∫—Å—Ç—Ä–∞-–∫–ª–∞—Å—Å–∞ üëë!¬ª.</b></p>
        <p><strong>–ü–æ—á–µ–º—É –∫—É—Ä—Å —Ç–µ–±–µ –ø–æ–¥—Ö–æ–¥–∏—Ç:</strong><br><b>–ö—É—Ä—Å ‚Äî —ç—Ç–æ –∫–ª—é—á –∫ –º–∏—Ä—É, –∫–æ—Ç–æ—Ä—ã–π —Ç—ã —Ö–æ—á–µ—à—å –ø–æ–Ω—è—Ç—å.</b> –¢—ã –±—É–¥–µ—à—å –Ω–µ ¬´–ø—Ä–æ—Ö–æ–¥–∏—Ç—å¬ª —É—Ä–æ–∫–∏, –∞ –ø–æ–≥—Ä—É–∂–∞—Ç—å—Å—è –≤ –Ω–∏—Ö, –∑–∞–¥–∞–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å—ã –∏ –ø–æ–ª—É—á–∞—Ç—å —É–¥–æ–≤–æ–ª—å—Å—Ç–≤–∏–µ –æ—Ç —Ç–æ–≥–æ, –∫–∞–∫ —Å–∫–ª–∞–¥—ã–≤–∞–µ—Ç—Å—è –æ–±—â–∞—è –∫–∞—Ä—Ç–∏–Ω–∞.<br><br><b>–¢—ã ‚Äî –Ω–µ –ø—Ä–æ—Å—Ç–æ —Å—Ç—É–¥–µ–Ω—Ç. –¢—ã ‚Äî –Ω–∞—à–∞ –º–µ—á—Ç–∞ üî•!</b>
–¢–∞–∫–æ–≥–æ –≥–æ—Ä–µ–Ω–∏—è –∏ –ª—é–±–æ–∑–Ω–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –Ω–µ –∫—É–ø–∏—Ç—å –∑–∞ –¥–µ–Ω—å–≥–∏.<br>–≠—Ç–æ –æ—á–µ–Ω—å —Ü–µ–Ω–Ω–æ üíé!<br>
–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –¥–æ–º–æ–π üíñ!<br>–ù–∞—á–Ω–µ–º —Å—Ç—Ä–æ–∏—Ç—å —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç —Ç–≤–æ–µ–≥–æ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª–∏–∑–º–∞ –≤ ML?!</p>
<p style="text-align: center;">–¢–∞–∫ –∫–∞–∫ —Ç—ã –±–ª–µ—Å—Ç—è—â–µ —Å–ø—Ä–∞–≤–∏–ª—Å—è üî•, –º—ã –¥–∞—Ä–∏–º —Ç–µ–±–µ –ø—Ä–æ–±–Ω—ã–π —É—Ä–æ–∫ üéÅ, –≤ –∫–æ—Ç–æ—Ä–æ–º —Ç—ã —Å –Ω—É–ª—è –ø–æ—Å—Ç—Ä–æ–∏—à—å —Ä–µ–∞–ª—å–Ω—É—é –º–æ–¥–µ–ª—å –∏ –≤—ã–ª–æ–∂–∏—à—å –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç üöÄ</p>
<div class="poehali">
<a class="ehali" href="https://rutube.ru/video/38f060a4dec7c665cb1312a3fb57596c/">üî• –ü–æ–µ—Ö–∞–ª–∏</a>
</div>
`
    };
  } else if (score >= 5 && score <= 6) {
    return {
      title: '–í–µ—Ä–¥–∏–∫—Ç 2: ¬´–ú–æ—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ß–µ–ª–æ–≤–µ–∫ –î–µ–ª–∞ üéØ¬ª (5-6 –±–∞–ª–ª–æ–≤)',
      subtitle: '<strong>–ü—Ä–∏–≤–µ—Ç, –ø—Ä–∞–∫—Ç–∏—á–Ω—ã–π –º–µ—á—Ç–∞—Ç–µ–ª—å!</strong><br>–£ —Ç–µ–±—è –µ—Å—Ç—å –≤–∞–∂–Ω–æ–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ ‚Äî —Ç—ã —á–µ—Ç–∫–æ –≤–∏–¥–∏—à—å —Ü–µ–ª—å: –¥–µ–Ω—å–≥–∏, –∫–∞—Ä—å–µ—Ä–∞, —Å—Ç–∞—Ç—É—Å üíºüí∏ –ò —ç—Ç–æ –æ—Ç–ª–∏—á–Ω–æ!',
      content: `
        <p><strong>–¢–≤–æ–π –ø–æ—Ä—Ç—Ä–µ—Ç:</strong><br>–¢—ã ‚Äî –∫–∞–∫ —É–º–Ω—ã–π –∏–Ω–≤–µ—Å—Ç–æ—Ä: –≤–∫–ª–∞–¥—ã–≤–∞–µ—à—å –≤—Ä–µ–º—è –∏ —Å–∏–ª—ã –≤ –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–Ω—ã–π –∞–∫—Ç–∏–≤.<br>–¢—ã –≥–æ—Ç–æ–≤ –ø–∞—Ö–∞—Ç—å, –Ω–æ –ø–æ–¥—Å–æ–∑–Ω–∞—Ç–µ–ª—å–Ω–æ –∂–¥–µ—à—å –±—ã—Å—Ç—Ä–æ–π –æ—Ç–¥–∞—á–∏ üí∏.<br>–ï—Å–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞—Å—Ç–∞–≤–ª—è–µ—Ç —Å–µ–±—è –∂–¥–∞—Ç—å ‚Äî –≤–Ω—É—Ç—Ä–∏ —á—Ç–æ-—Ç–æ —â–µ–ª–∫–∞–µ—Ç: ¬´–ê —Å—Ç–æ–∏—Ç –ª–∏ –æ–Ω–æ —Ç–æ–≥–æü§î?¬ª<br>–ü–æ–º–Ω–∏: –∫—É—Ä—Å –¥–∞—ë—Ç –ø–µ—Ä–≤—ã–π —à–∞–≥ –≤ ML</p>
        <p><strong>–ü–æ—á–µ–º—É —Ç–µ–±–µ –Ω—É–∂–Ω–æ –ø–æ–¥—É–º–∞—Ç—å:</strong> –ì–ª–∞–≤–Ω—ã–π –≤—ã–∑–æ–≤ ‚Äî –Ω–µ —Å–¥–∞—Ç—å—Å—è –≤ ¬´–¥–æ–ª–∏–Ω–µ —Ä–∞–∑–æ—á–∞—Ä–æ–≤–∞–Ω–∏—è¬ª üèúÔ∏è, –∫–æ—Ç–æ—Ä–∞—è —á–∞—Å—Ç–æ –±—ã–≤–∞–µ—Ç –≤ —Å–µ—Ä–µ–¥–∏–Ω–µ –æ–±—É—á–µ–Ω–∏—è.<br>–ö–æ–≥–¥–∞ —ç–π—Ñ–æ—Ä–∏—è –ø—Ä–æ—à–ª–∞, –∞ –¥–æ —Ñ–∏–Ω–∏—à–∞ –µ—â–µ –¥–∞–ª–µ–∫–æ üèÅ.<br><br>–ü–æ–º–Ω–∏: ML ‚Äî —ç—Ç–æ –∫–∞–∫ –∫–∞—á–∞—Ç—å –º—ã—à—Ü—ã üí™.<br>–°–Ω–∞—á–∞–ª–∞ —Ç—Ä—É–¥–Ω–æ, –Ω–æ —Å –∫–∞–∂–¥–æ–π –Ω–µ–¥–µ–ª–µ–π —Ç—ã —Å—Ç–∞–Ω–æ–≤–∏—à—å—Å—è —Å–∏–ª—å–Ω–µ–µ üß†.<br>
        –ï—Å–ª–∏ –≥–æ—Ç–æ–≤ –ø–µ—Ä–µ–π—Ç–∏ –æ—Ç ¬´—Ö–æ—á—É¬ª –∫ ¬´–¥–µ–ª–∞—é¬ª, –¢–≤–æ–π –ø—Ä–∞–≥–º–∞—Ç–∏–∑–º + –ù–∞—à–∞ —Å–∏—Å—Ç–µ–º–∞ = —Ä–∞–±–æ—á–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç üî•<br><br>
        –ì–æ—Ç–æ–≤ –ª–∏ —Ç—ã –ø—Ä–æ–π—Ç–∏ —ç—Ç–æ—Ç –ø—É—Ç—å –¥–∞–∂–µ –∫–æ–≥–¥–∞ –±—É–¥–µ—Ç –Ω–µ–∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ?<br>–ï—Å–ª–∏ –¥–∞ ‚Äî –¥–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –∫–æ–º–∞–Ω–¥—É! üöÄ</p>
        <p style="text-align: center;">–î–∞–≤–∞–π –ø—Ä–æ–≤–µ—Ä–∏–º: –º—ã –¥–∞—Ä–∏–º —Ç–µ–±–µ –ø—Ä–æ–±–Ω—ã–π —É—Ä–æ–∫ üéÅ, –≤ –∫–æ—Ç–æ—Ä–æ–º —Ç—ã —Å –Ω—É–ª—è –ø–æ—Å—Ç—Ä–æ–∏—à—å —Ä–µ–∞–ª—å–Ω—É—é –º–æ–¥–µ–ª—å –∏ –≤—ã–ª–æ–∂–∏—à—å –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç üöÄ</p>
        <div class="poehali">
        <a class="ehali" href="https://rutube.ru/video/38f060a4dec7c665cb1312a3fb57596c/">üî• –ü–æ–µ—Ö–∞–ª–∏</a>
        </div>
        `
    };
  } else {
    return {
      title: '–í–µ—Ä–¥–∏–∫—Ç 3: ¬´–ò—Å–∫–∞—Ç–µ–ª—å –õ—ë–≥–∫–∏—Ö –ü—É—Ç–µ–π üéØ¬ª (3-4 –±–∞–ª–ª–∞)',
      subtitle: '–î—Ä—É–≥, –¥–∞–≤–∞–π –Ω–∞—á–∏—Å—Ç–æ—Ç—É! –≠—Ç–æ—Ç –∫—É—Ä—Å –ø–æ—Ç—Ä–µ–±—É–µ—Ç –æ—Ç —Ç–µ–±—è –Ω–∞—Å—Ç–æ—è—â–µ–π –±–∏—Ç–≤—ã —Å —Å–∞–º–∏–º —Å–æ–±–æ–π ‚öîÔ∏è. –•–æ—Ä–æ—à–æ –ø–æ–¥—É–º–∞–π –ø–µ—Ä–µ–¥ –ø–æ–∫—É–ø–∫–æ–π: –≥–æ—Ç–æ–≤ –ª–∏ —Ç—ã –Ω–∞–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ –æ–±—É—á–µ–Ω–∏–µ —Å–≤–æ–π —Ñ–æ–∫—É—Å –∏ –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—é?',
      content: `
        <p><strong>–¢–≤–æ–π –ø–æ—Ä—Ç—Ä–µ—Ç:</strong><br>–¢—ã –∂–¥–µÃà—à—å –≤–æ–ª—à–µ–±–Ω—É—é —Ç–∞–±–ª–µ—Ç–∫—É üíä ‚Äî —á—Ç–æ–±—ã –∑–Ω–∞–Ω–∏—è —Å–∞–º–∏ –ø–æ–ø–∞–ª–∏ –≤ –≥–æ–ª–æ–≤—É –±–µ–∑ —É—Å–∏–ª–∏–π.<br>–¢—ã —Ö–æ—á–µ—à—å –ø–µ—Ä–µ–º–µ–Ω, –Ω–æ –ø–æ–≥—Ä—É–∂–∞—Ç—å—Å—è –≤ –¥–µ—Ç–∞–ª–∏ –∫–∞–∂–µ—Ç—Å—è —Å–∫—É—á–Ω—ã–º.<br>–¢–≤–æ—è –º–æ—Ç–∏–≤–∞—Ü–∏—è ‚Äî –∫–∞–∫ –ø–æ–ø—É—Ç–Ω—ã–π –≤–µ—Ç–µ—Ä ‚õµ: —Å–µ–≥–æ–¥–Ω—è –µ—Å—Ç—å ‚úÖ, –∞ –∑–∞–≤—Ç—Ä–∞ –Ω–µ—Ç ‚ùå.</p>
        <p><strong>–ü–æ—á–µ–º—É –∫—É–ø–∏—Ç—å AiM-–∫—É—Ä—Å - —ç—Ç–æ —Ä–∏—Å–∫:</strong> –û–±—É—á–µ–Ω–∏–µ —Ç—Ä–µ–±—É–µ—Ç —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞ –∏ —É–ø–æ—Ä—Å—Ç–≤–∞. –¢—ã —Ä–∏—Å–∫—É–µ—à—å –±—ã—Å—Ç—Ä–æ —Ä–∞–∑–æ—á–∞—Ä–æ–≤–∞—Ç—å—Å—è, –ø–æ—Ç–æ–º—É —á—Ç–æ —Ç–µ–±–µ –±—É–¥–µ—Ç ¬´—Å–∫—É—á–Ω–æ¬ª –∏–ª–∏ ¬´—Å–ª–æ–∂–Ω–æ¬ª, –∏ –±—Ä–æ—Å–∏—à—å –æ–±—É—á–µ–Ω–∏–µ –Ω–∞ —Ä–∞–Ω–Ω–∏—Ö "—Å–∫—É—á–Ω—ã—Ö" —ç—Ç–∞–ø–∞—Ö.<br><br>
        <strong>–ñ–µ—Å—Ç–∫–∞—è –ø—Ä–∞–≤–¥–∞</strong>:<br>
        –ï—Å–ª–∏ —Ç—ã –Ω–µ –≥–æ—Ç–æ–≤ –°–ï–ô–ß–ê–° –ø–µ—Ä–µ—Å—Ç—Ä–æ–∏—Ç—å —Å–≤–æ–π –ø–æ–¥—Ö–æ–¥ –∏ —Å–∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è ‚Äî —Ç—ã –ø—Ä–æ—Å—Ç–æ –≤—ã–±—Ä–æ—Å–∏—à—å –¥–µ–Ω—å–≥–∏ –Ω–∞ –≤–µ—Ç–µ—Ä üí∏<br><br>
        <strong>–ù–æ –µ—Å—Ç—å –∏ —Ö–æ—Ä–æ—à–∞—è –Ω–æ–≤–æ—Å—Ç—å!</strong>
        –ï—Å–ª–∏ —Ç—ã –æ—Å–æ–∑–Ω–∞–Ω–Ω–æ —Ä–µ—à–∏—à—å –∏–∑–º–µ–Ω–∏—Ç—å—Å—è ‚Äî —ç—Ç–æ—Ç –∫—É—Ä—Å —Å—Ç–∞–Ω–µ—Ç —Ç–≤–æ–∏–º –ø–æ–ª–∏–≥–æ–Ω–æ–º –¥–ª—è –ø—Ä–æ–∫–∞—á–∫–∏ —Å–∏–ª—ã –≤–æ–ª–∏ üí™!<br><br>
        <strong>–°–ø—Ä–æ—Å–∏ —Å–µ–±—è —á–µ—Å—Ç–Ω–æ:</strong><br>
        ¬´–ì–æ—Ç–æ–≤ –ª–∏ —è –≤—ã–¥–µ–ª—è—Ç—å 2-3 —á–∞—Å–∞ –≤ –¥–µ–Ω—å –Ω–∞ –ø—Ä–∞–∫—Ç–∏–∫—É?<br>–ù–µ —Å–¥–∞–≤–∞—Ç—å—Å—è –ø—Ä–∏ –ø–µ—Ä–≤—ã—Ö –æ—à–∏–±–∫–∞—Ö?<br>–î–æ–≤–æ–¥–∏—Ç—å –¥–µ–ª–æ –¥–æ –∫–æ–Ω—Ü–∞?¬ª<br><br>
        –ï—Å–ª–∏ –æ—Ç–≤–µ—Ç ¬´–î–ê¬ª ‚Äî –¥–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –∫–ª—É–±!<br>
        –ï—Å–ª–∏ —Å–æ–º–Ω–µ–≤–∞–µ—à—å—Å—è ‚Äî –≤–æ–∑–º–æ–∂–Ω–æ, —Å—Ç–æ–∏—Ç —Å–Ω–∞—á–∞–ª–∞ –ø–æ—Ç—Ä–µ–Ω–∏—Ä–æ–≤–∞—Ç—å –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—É –Ω–∞ —á–µ–º-—Ç–æ –ø–æ–ø—Ä–æ—â–µ ‚ú®<br><br>
        –ü—É—Ç—å ML ‚Äî —ç—Ç–æ –º–∞—Ä–∞—Ñ–æ–Ω, –∞ –Ω–µ —Å–ø—Ä–∏–Ω—Ç. –í—ã–±–∏—Ä–∞–π —Å —É–º–æ–º! üß†
      `
    };
  }
}

function renderStep(container, stepIndex, answers, onDone) {
  container.innerHTML = '';
  if (stepIndex >= quizData.length) {
    const score = calculateScore(answers);
    const verdict = getVerdict(score);
    const done = document.createElement('div');
    done.className = 'verdict';
    done.innerHTML = `
      <p style="margin-top: 20px; text-align: center;">–í–∞—à —Ä–µ–∑—É–ª—å—Ç–∞—Ç: ${score} –±–∞–ª–ª–æ–≤</p>
      <h3>${verdict.title}</h3>
      <p style="font-weight: bold; margin-top: 10px;">${verdict.subtitle}</p>
      <div class="verdict-content">
        ${verdict.content}
      </div>
      <div class="answers" style="margin-top: 20px;">
        <button id="buyFull" class="right">–ö—É–ø–∏—Ç—å –ø–æ–ª–Ω—É—é –≤–µ—Ä—Å–∏—é</button>
      </div>
    `;
    container.appendChild(done);
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏—Ç–æ–≥–æ–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    sendProgress('final_score', score.toString());
    sendProgress('final_verdict', verdict.title);
    
    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–ö—É–ø–∏—Ç—å –ø–æ–ª–Ω—É—é –≤–µ—Ä—Å–∏—é"
    const buyBtn = document.getElementById('buyFull');
    if (buyBtn) {
      buyBtn.addEventListener('click', () => {
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ü–µ–ª—å go_to_bot –≤ –Ø–Ω–¥–µ–∫—Å –ú–µ—Ç—Ä–∏–∫—É
        if (window.ym && typeof window.ym === 'function') {
          try {
            window.ym(window.YANDEX_METRIKA_ID, 'reachGoal', 'go_to_bot');
          } catch (e) {
            console.error('Yandex Metrika error:', e);
          }
        }
        window.location.href = 'https://t.me/AiM_Pay_Bot?start=me';
      });
    }
    return;
  }

  const item = quizData[stepIndex];
  const wrap = document.createElement('div');
  wrap.className = 'question';

  const title = document.createElement('h3');
  title.innerHTML = item.title;
  wrap.appendChild(title);

  const body = document.createElement('div');
  const next = document.createElement('button');
  next.textContent = '–î–∞–ª–µ–µ ‚Üí';
  next.classList.add("right");
  next.disabled = !answers[stepIndex];
  next.addEventListener('click', () => onDone());
  window.scrollTo({ top: 0, behavior: 'smooth' });
  if (item.type === 'choice') {
    const btns = document.createElement('div');
    btns.className = 'answers';
    const currentAnswer = answers[stepIndex] || savedAnswers[`final_q${stepIndex + 1}`];
    
    item.options.forEach(opt => {
      const div = document.createElement('div');
      const b = document.createElement('button');
      const p = document.createElement('p');
      div.classList.add("contic")
      b.innerHTML = opt.answer;
      b.classList.add("ans")
      p.innerHTML = opt.description;
      p.classList.add("descr")
      if (currentAnswer === opt) {
        b.classList.add('selectedd');
      }
      b.addEventListener('click', () => {
        // –†–∞–∑—Ä–µ—à–∞–µ–º –∏–∑–º–µ–Ω–∏—Ç—å –≤—ã–±–æ—Ä
        btns.querySelectorAll('button').forEach(x => x.classList.remove('selectedd'));
        b.classList.add('selectedd');
        answers[stepIndex] = opt;
        next.disabled = false;
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç —Å—Ä–∞–∑—É
        sendProgress(`final_q${stepIndex + 1}`, opt);
      });
      div.appendChild(b)
      div.appendChild(p)
      btns.appendChild(div);
    });
    body.appendChild(btns);
  }

  wrap.appendChild(body);
  const footer = document.createElement('div');
  footer.className = 'footer';
  footer.appendChild(next);
  wrap.appendChild(footer);
  container.appendChild(wrap);
}

(async function init() {
  await loadSavedAnswers();
  const root = document.getElementById('quiz');
  let step = 0;
  const answers = [];
  
  // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –≤ –º–∞—Å—Å–∏–≤
  quizData.forEach((_, idx) => {
    const saved = savedAnswers[`final_q${idx + 1}`];
    if (saved) {
      answers[idx] = saved;
    }
  });
  
  const next = () => {
    step += 1;
    renderStep(root, step, answers, next);
  };
  renderStep(root, step, answers, next);
})();


