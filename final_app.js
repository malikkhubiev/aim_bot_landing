(function(){
  function getParam(name){ const u = new URL(window.location.href); return u.searchParams.get(name); }

  const steps = [
    { 
      id:'final_q1', 
      title:'–í–æ–ø—Ä–æ—Å 1: –¢—ã —Å–º–æ—Ç—Ä–∏—à—å –≤–∏–¥–µ–æ. –¢–≤–æ—è –ª—é–±–∏–º–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ ‚Äî —ç—Ç–æ...', 
      text:'–¢—ã —Å–º–æ—Ç—Ä–∏—à—å –≤–∏–¥–µ–æ. –¢–≤–æ—è –ª—é–±–∏–º–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ ‚Äî —ç—Ç–æ...', 
      choices:[
        '–∞) x1.25 | x1.5 | x2.<br><br>–ú–æ–π –º–æ–∑–≥ –º–æ–∂–µ—Ç —É—Å–≤–∞–∏–≤–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –±—ã—Å—Ç—Ä–µ–µ, –∞ –ª–µ–∫—Ç–æ—Ä—ã –ª—é–±—è—Ç –≥–æ–≤–æ—Ä–∏—Ç—å –±–∞–Ω–∞–ª—å–Ω—ã–µ –≤–µ—â–∏.',
        '–±) –û–±—ã—á–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å (x1.0).<br><br>–õ—é–±–ª—é –≤–Ω–∏–∫–∞—Ç—å –≤ –¥–µ—Ç–∞–ª–∏, –¥–∞–∂–µ –µ—Å–ª–∏ —ç—Ç–æ –º–µ–¥–ª–µ–Ω–Ω–µ–µ.',
        '–≤) –ú–µ–Ω—è –¥–æ–ª–∂–Ω–æ –∑–∞—Ü–µ–ø–∏—Ç—å —Å –ø–µ—Ä–≤—ã—Ö —Å–µ–∫—É–Ω–¥.<br><br>–ï—Å–ª–∏ —ç—Ç–æ–≥–æ –Ω–µ –ø—Ä–æ–∏–∑–æ—à–ª–æ, —Ç–æ –¥–∞–ª—å—à–µ –Ω–µ–∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ.'
      ] 
    },
    { 
      id:'final_q2', 
      title:'–í–æ–ø—Ä–æ—Å 2: –¢—ã –≤ –≥–∞—Ä–∞–∂–µ —Å –Ω–æ–≤–æ–π Lamborghini –∏ —É —Ç–µ–±—è –Ω–∞–±–æ—Ä –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤.<br>–ß—Ç–æ –¥–µ–ª–∞–µ—à—å –≤ –ø–µ—Ä–≤—É—é –æ—á–µ—Ä–µ–¥—å?', 
      text:'–¢—ã –≤ –≥–∞—Ä–∞–∂–µ —Å –Ω–æ–≤–æ–π Lamborghini –∏ —É —Ç–µ–±—è –Ω–∞–±–æ—Ä –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤.<br>–ß—Ç–æ –¥–µ–ª–∞–µ—à—å –≤ –ø–µ—Ä–≤—É—é –æ—á–µ—Ä–µ–¥—å?', 
      choices:[
        '–∞) –ü–æ–ø—Ä–æ–±—É—é –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∫–∞–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ –µ—Å—Ç—å –Ω–∞ –ø–∞–Ω–µ–ª–∏ –≤ —Å–∞–ª–æ–Ω–µ.<br><br> –ü–æ—Ä–∞–∑–º—ã—à–ª—è—é –∫–∞–∫ —ç—Ç–æ –º–æ–≥–ª–æ –±—ã—Ç—å –ø–æ—Å—Ç—Ä–æ–µ–Ω–æ. <br><br> –ó–∞—Ç–µ–º, –ø–æ–ª–µ–∑—É –ø–æ–¥ –∫–∞–ø–æ—Ç –∏ –±—É–¥—É –∫–æ–≤—ã—Ä—è—Ç—å—Å—è, —á—Ç–æ–±—ã –∏–∑—É—á–∏—Ç—å –∫–∞–∂–¥—É—é –¥–µ—Ç–∞–ª—å –ø–æ –æ—Ç–¥–µ–ª—å–Ω–æ—Å—Ç–∏ (–∞–Ω–∞–ª–∏–∑) –∏ –∏–º–µ—Ç—å –ø–æ–ª–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –æ –≤—Å–µ–π —Å–∏—Å—Ç–µ–º–µ (—Å–∏–Ω—Ç–µ–∑).',
        '–±) –û—Ç–∫—Ä–æ—é –∫–∞–ø–æ—Ç, —É–≤–∏–∂—É, —á—Ç–æ —Ç–∞–º –º–Ω–æ–≥–æ –≤—Å–µ–≥–æ.<br><br>–ù–∞—á–Ω—É –æ—Ç–∫—Ä—É—á–∏–≤–∞—Ç—å, –Ω–∞—á–Ω—ë—Ç –ø–æ–ª—É—á–∞—Ç—å—Å—è, –ø–æ—Ç–æ–º —Å–ª—É—á–∞–π–Ω–æ –º–æ–≥—É –æ—Ç–≤–ª–µ—á—å—Å—è –∏ –∑–∞–±—ã—Ç—å —á—Ç–æ –∑–∞ —á–µ–º –∏–¥—ë—Ç.<br><br>–ù–∞ —ç—Ç–æ–º —Ö–≤–∞—Ç–∏—Ç, –¥–∞–ª—å—à–µ –Ω–µ—Ç —Å–º—ã—Å–ª–∞ –ø—ã—Ç–∞—Ç—å—Å—è, –ø–æ–ª–æ–∂—É –Ω–∞ –º–µ—Å—Ç–æ, –ª—É—á—à–µ –ø–æ—Å–∏–∂—É –≤ —Å–∞–ª–æ–Ω–µ.',
        '–≤) –Ø –ø–æ–¥ –∫–∞–ø–æ—Ç –ª–µ–∑—Ç—å –Ω–µ —Å–æ–±–∏—Ä–∞—é—Å—å.<br><br> –ê –≤–¥—Ä—É–≥ —è —Ç–∞–º —Å–ª–æ–º–∞—é —á—Ç–æ-–Ω–∏–±—É–¥—å. –ß—Ç–æ –º–Ω–µ –≥–æ–ª–æ–≤—É –∑–∞–±–∏–≤–∞—Ç—å –∫–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –º–∞—à–∏–Ω–∞?<br><br>–ü–æ—Ö–æ–∂—É –ø–æ –≥–∞—Ä–∞–∂—É, –ø–æ—Å—á–∏—Ç–∞—é –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —à–∞–≥–æ–≤.'
      ] 
    },
    { 
      id:'final_q3', 
      title:'–í–æ–ø—Ä–æ—Å 3: –ü–æ—á–µ–º—É —Ç—ã –≤–æ–æ–±—â–µ —Ö–æ—á–µ—à—å —É—á–∏—Ç—å—Å—è Machine Learning?', 
      text:'–ü–æ—á–µ–º—É —Ç—ã –≤–æ–æ–±—â–µ —Ö–æ—á–µ—à—å —É—á–∏—Ç—å—Å—è Machine Learning?', 
      choices:[
        '–∞) –ú–Ω–µ –ò–ù–¢–ï–†–ï–°–ù–û, –∫–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç.<br><br>–•–æ—á—É –ø–æ–Ω–∏–º–∞—Ç—å –≤ —á—ë–º –∏–¥–µ—è, –æ—Å–≤–æ–∏—Ç—å –Ω–æ–≤—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã, —Ä–∞–∑–≤–∏–≤–∞—Ç—å —Å–≤–æ–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç.<br><br>–ï—Å–ª–∏ —Ç–∞–º —Ä–µ–∞–ª—å–Ω–æ –∫—Ä—É—Ç–æ, —Ç–æ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∏–∑—É—á–∞—Ç—å –∏ —Å—Ç–∞—Ç—å –≤—ã–¥–∞—é—â–∏–º—Å—è –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª–æ–º —á–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ –ª–µ—Ç.',
        '–±) –≠—Ç–æ –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–Ω–æ –∏ –∑–∞ —ç—Ç–æ —Ö–æ—Ä–æ—à–æ –ø–ª–∞—Ç—è—Ç.<br><br>–ù–ê–î–û –æ—Å–≤–∞–∏–≤–∞—Ç—å –Ω–æ–≤—ã–µ –Ω–∞–≤—ã–∫–∏, —á—Ç–æ–±—ã –±—ã—Ç—å –≤ —Ç–µ–º–µ.<br><br>–ü–ª—é—Å, –∑–ø —Ö–æ—á—É –ø–æ–±–æ–ª—å—à–µ, –∞ –≤ IT –≤—Ä–æ–¥–µ –ø–ª–∞—Ç—è—Ç.',
        '–≤) –Ø –ø–æ—Ç–µ—Ä—è–Ω.<br><br>–Ø –≤—Ä–æ–¥–µ —Ö–æ—á—É —á—Ç–æ-—Ç–æ –∏–∑—É—á–∞—Ç—å, –Ω–æ –Ω–µ –∑–Ω–∞—é —á—Ç–æ.<br><br>–•–æ—á—É –∫–æ–º—É-—Ç–æ –∑–∞–ø–ª–∞—Ç–∏—Ç—å, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –æ—â—É—â–µ–Ω–∏–µ, —á—Ç–æ —è –Ω–∞—á–∞–ª –ø—Ä–∏–Ω–∏–º–∞—Ç—å smart —Ä–µ—à–µ–Ω–∏—è, –∞ —Ç–∞–º –º–µ–Ω—è –∑–∞ —Ä—É—á–∫—É –¥–æ–≤–µ–¥—É—Ç –¥–æ –¥–µ–Ω–µ–≥.'
      ] 
    }
  ];

  function render(idx){
    const s = steps[idx];
    const host = document.getElementById('quiz');
    const answers = s.choices.map((c,i)=>`<button class="right" data-i="${i}">${c}</button>`).join('');
    host.innerHTML = `
      <div class="question">
        <div class="hint">–®–∞–≥ ${idx+1} –∏–∑ ${steps.length}</div>
        <h2>${s.title}</h2>
        <p>${s.text}</p>
        <div class="answers">${answers}</div>
      </div>
    `;
    host.querySelectorAll('button[data-i]').forEach(btn => {
      btn.addEventListener('click', async () => {
        const answer = s.choices[Number(btn.getAttribute('data-i'))];
        await window.AimQuestState.saveProgress({ stage:'final', stepKey:s.id, stepIndex:idx, answer, meta:null });
        if (idx < steps.length-1) return render(idx+1);
        return renderDone();
      });
    });
  }

  function renderDone(){
    const host = document.getElementById('quiz');
    host.innerHTML = `
      <div class="question">
        <h2>–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—ã –∑–∞–≤–µ—Ä—à–∏–ª–∏ –∫–≤–µ—Å—Ç üéâ</h2>
        <div class="verdict">
          <h3>–ò—Ç–æ–≥–æ–≤—ã–π –æ—Ç—á—ë—Ç</h3>
          <div class="verdict-content">–í–∞—à–∏ –æ—Ç–≤–µ—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã. –ú–µ–Ω–µ–¥–∂–µ—Ä —É–≤–∏–¥–∏—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å –∏ —Å–≤—è–∂–µ—Ç—Å—è –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏.</div>
        </div>
        <div class="answers">
          <button id="toStart" class="right">–ù–∞ –≥–ª–∞–≤–Ω—É—é</button>
          <button id="buyFull" class="right" style="background-color: #E83141; margin-top: 10px;">–ö—É–ø–∏—Ç—å –ø–æ–ª–Ω—É—é –≤–µ—Ä—Å–∏—é</button>
        </div>
      </div>
    `;
    document.getElementById('toStart').addEventListener('click', async () => {
      await window.AimQuestState.saveProgress({ stage:'final', stepKey:'completed', stepIndex:steps.length-1, answer:'done', meta:null });
      const ctx = window.AimQuestState.getContext();
      const url = window.AimQuestState.buildUrl('index.html', ctx.leadId ? { lead_id: ctx.leadId } : {});
      window.location.href = url;
    });
    document.getElementById('buyFull').addEventListener('click', () => {
      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ü–µ–ª—å go_to_bot –≤ –Ø–Ω–¥–µ–∫—Å –ú–µ—Ç—Ä–∏–∫—É
      if (window.ym && typeof window.ym === 'function') {
        try {
          window.ym(window.YANDEX_METRIKA_ID, 'reachGoal', 'go_to_bot');
        } catch (e) {
          console.error('Yandex Metrika error:', e);
        }
      }
      window.location.href = 'https://t.me/AiM_Pay_Bot';
    });
  }

  window.addEventListener('DOMContentLoaded', async () => {
    const leadId = getParam('lead_id');
    if (leadId) window.AimQuestState.setLeadContext({ leadId });
    try {
      const last = await window.AimQuestState.getLastProgress();
      if (last && last.stage === 'final' && typeof last.step_index === 'number'){
        return render(Math.min(steps.length-1, Math.max(0, last.step_index)));
      }
    } catch(_){ }
    render(0);
  });
})();

const API_BASE = 'https://aim-pay-bot-server-4c57.onrender.com';

function getLeadId() {
  const url = new URL(window.location.href);
  return url.searchParams.get('lead_id');
}

async function sendProgress(step, answer) {
  const leadId = getLeadId();
  if (!leadId) return;
  try {
    const response = await fetch(`${API_BASE}/form_warm/clients/${leadId}/answers`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ step, answer })
    });
    // –ï—Å–ª–∏ –æ—Ç–≤–µ—Ç —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç (409), –æ–±–Ω–æ–≤–ª—è–µ–º –µ–≥–æ
    if (response.status === 409) {
      await fetch(`${API_BASE}/form_warm/clients/${leadId}/answers`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ step, answer })
      });
    }
  } catch (_) {}
}

// –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã
let savedAnswers = {};
async function loadSavedAnswers() {
  const leadId = getLeadId();
  if (!leadId) return;
  try {
    const resp = await fetch(`${API_BASE}/form_warm/clients/${leadId}/progress`);
    const data = await resp.json();
    if (data.status === 'success' && data.progress) {
      data.progress.forEach(p => {
        savedAnswers[p.step] = p.answer;
      });
    }
  } catch (_) {}
}

const quizData = [
  {
    type: 'choice',
    title: '–í–æ–ø—Ä–æ—Å 1: –¢—ã —Å–º–æ—Ç—Ä–∏—à—å –≤–∏–¥–µ–æ. –¢–≤–æ—è –ª—é–±–∏–º–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ ‚Äî —ç—Ç–æ...',
    options: [
      '–∞) x1.25 | x1.5 | x2.<br><br>–ú–æ–π –º–æ–∑–≥ –º–æ–∂–µ—Ç —É—Å–≤–∞–∏–≤–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –±—ã—Å—Ç—Ä–µ–µ, –∞ –ª–µ–∫—Ç–æ—Ä—ã –ª—é–±—è—Ç –≥–æ–≤–æ—Ä–∏—Ç—å –±–∞–Ω–∞–ª—å–Ω—ã–µ –≤–µ—â–∏.',
      '–±) –û–±—ã—á–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å (x1.0).<br><br>–õ—é–±–ª—é –≤–Ω–∏–∫–∞—Ç—å –≤ –¥–µ—Ç–∞–ª–∏, –¥–∞–∂–µ –µ—Å–ª–∏ —ç—Ç–æ –º–µ–¥–ª–µ–Ω–Ω–µ–µ.',
      '–≤) –ú–µ–Ω—è –¥–æ–ª–∂–Ω–æ –∑–∞—Ü–µ–ø–∏—Ç—å —Å –ø–µ—Ä–≤—ã—Ö —Å–µ–∫—É–Ω–¥.<br><br>–ï—Å–ª–∏ —ç—Ç–æ–≥–æ –Ω–µ –ø—Ä–æ–∏–∑–æ—à–ª–æ, —Ç–æ –¥–∞–ª—å—à–µ –Ω–µ–∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ.'
    ],
    scores: { '–∞': 3, '–±': 2, '–≤': 1 }
  },
  {
    type: 'choice',
    title: '–í–æ–ø—Ä–æ—Å 2: –¢—ã –≤ –≥–∞—Ä–∞–∂–µ —Å –Ω–æ–≤–æ–π Lamborghini –∏ —É —Ç–µ–±—è –Ω–∞–±–æ—Ä –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤.<br>–ß—Ç–æ –¥–µ–ª–∞–µ—à—å –≤ –ø–µ—Ä–≤—É—é –æ—á–µ—Ä–µ–¥—å?',
    options: [
      '–∞) –ü–æ–ø—Ä–æ–±—É—é –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∫–∞–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ –µ—Å—Ç—å –Ω–∞ –ø–∞–Ω–µ–ª–∏ –≤ —Å–∞–ª–æ–Ω–µ.<br><br> –ü–æ—Ä–∞–∑–º—ã—à–ª—è—é –∫–∞–∫ —ç—Ç–æ –º–æ–≥–ª–æ –±—ã—Ç—å –ø–æ—Å—Ç—Ä–æ–µ–Ω–æ. <br><br> –ó–∞—Ç–µ–º, –ø–æ–ª–µ–∑—É –ø–æ–¥ –∫–∞–ø–æ—Ç –∏ –±—É–¥—É –∫–æ–≤—ã—Ä—è—Ç—å—Å—è, —á—Ç–æ–±—ã –∏–∑—É—á–∏—Ç—å –∫–∞–∂–¥—É—é –¥–µ—Ç–∞–ª—å –ø–æ –æ—Ç–¥–µ–ª—å–Ω–æ—Å—Ç–∏ (–∞–Ω–∞–ª–∏–∑) –∏ –∏–º–µ—Ç—å –ø–æ–ª–Ω–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –æ –≤—Å–µ–π —Å–∏—Å—Ç–µ–º–µ (—Å–∏–Ω—Ç–µ–∑).',
      '–±) –û—Ç–∫—Ä–æ—é –∫–∞–ø–æ—Ç, —É–≤–∏–∂—É, —á—Ç–æ —Ç–∞–º –º–Ω–æ–≥–æ –≤—Å–µ–≥–æ.<br><br>–ù–∞—á–Ω—É –æ—Ç–∫—Ä—É—á–∏–≤–∞—Ç—å, –Ω–∞—á–Ω—ë—Ç –ø–æ–ª—É—á–∞—Ç—å—Å—è, –ø–æ—Ç–æ–º —Å–ª—É—á–∞–π–Ω–æ –º–æ–≥—É –æ—Ç–≤–ª–µ—á—å—Å—è –∏ –∑–∞–±—ã—Ç—å —á—Ç–æ –∑–∞ —á–µ–º –∏–¥—ë—Ç.<br><br>–ù–∞ —ç—Ç–æ–º —Ö–≤–∞—Ç–∏—Ç, –¥–∞–ª—å—à–µ –Ω–µ—Ç —Å–º—ã—Å–ª–∞ –ø—ã—Ç–∞—Ç—å—Å—è, –ø–æ–ª–æ–∂—É –Ω–∞ –º–µ—Å—Ç–æ, –ª—É—á—à–µ –ø–æ—Å–∏–∂—É –≤ —Å–∞–ª–æ–Ω–µ.',
      '–≤) –Ø –ø–æ–¥ –∫–∞–ø–æ—Ç –ª–µ–∑—Ç—å –Ω–µ —Å–æ–±–∏—Ä–∞—é—Å—å.<br><br> –ê –≤–¥—Ä—É–≥ —è —Ç–∞–º —Å–ª–æ–º–∞—é —á—Ç–æ-–Ω–∏–±—É–¥—å. –ß—Ç–æ –º–Ω–µ –≥–æ–ª–æ–≤—É –∑–∞–±–∏–≤–∞—Ç—å –∫–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –º–∞—à–∏–Ω–∞?<br><br>–ü–æ—Ö–æ–∂—É –ø–æ –≥–∞—Ä–∞–∂—É, –ø–æ—Å—á–∏—Ç–∞—é –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —à–∞–≥–æ–≤.'
    ],
    scores: { '–∞': 3, '–±': 2, '–≤': 1 }
  },
  {
    type: 'choice',
    title: '–í–æ–ø—Ä–æ—Å 3: –ü–æ—á–µ–º—É —Ç—ã –≤–æ–æ–±—â–µ —Ö–æ—á–µ—à—å —É—á–∏—Ç—å—Å—è Machine Learning?',
    options: [
      '–∞) –ú–Ω–µ –ò–ù–¢–ï–†–ï–°–ù–û, –∫–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç.<br><br>–•–æ—á—É –ø–æ–Ω–∏–º–∞—Ç—å –≤ —á—ë–º –∏–¥–µ—è, –æ—Å–≤–æ–∏—Ç—å –Ω–æ–≤—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã, —Ä–∞–∑–≤–∏–≤–∞—Ç—å —Å–≤–æ–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç.<br><br>–ï—Å–ª–∏ —Ç–∞–º —Ä–µ–∞–ª—å–Ω–æ –∫—Ä—É—Ç–æ, —Ç–æ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∏–∑—É—á–∞—Ç—å –∏ —Å—Ç–∞—Ç—å –≤—ã–¥–∞—é—â–∏–º—Å—è –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª–æ–º —á–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ –ª–µ—Ç.',
      '–±) –≠—Ç–æ –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–Ω–æ –∏ –∑–∞ —ç—Ç–æ —Ö–æ—Ä–æ—à–æ –ø–ª–∞—Ç—è—Ç.<br><br>–ù–ê–î–û –æ—Å–≤–∞–∏–≤–∞—Ç—å –Ω–æ–≤—ã–µ –Ω–∞–≤—ã–∫–∏, —á—Ç–æ–±—ã –±—ã—Ç—å –≤ —Ç–µ–º–µ.<br><br>–ü–ª—é—Å, –∑–ø —Ö–æ—á—É –ø–æ–±–æ–ª—å—à–µ, –∞ –≤ IT –≤—Ä–æ–¥–µ –ø–ª–∞—Ç—è—Ç.',
      '–≤) –Ø –ø–æ—Ç–µ—Ä—è–Ω.<br><br>–Ø –≤—Ä–æ–¥–µ —Ö–æ—á—É —á—Ç–æ-—Ç–æ –∏–∑—É—á–∞—Ç—å, –Ω–æ –Ω–µ –∑–Ω–∞—é —á—Ç–æ.<br><br>–•–æ—á—É –∫–æ–º—É-—Ç–æ –∑–∞–ø–ª–∞—Ç–∏—Ç—å, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –æ—â—É—â–µ–Ω–∏–µ, —á—Ç–æ —è –Ω–∞—á–∞–ª –ø—Ä–∏–Ω–∏–º–∞—Ç—å smart —Ä–µ—à–µ–Ω–∏—è, –∞ —Ç–∞–º –º–µ–Ω—è –∑–∞ —Ä—É—á–∫—É –¥–æ–≤–µ–¥—É—Ç –¥–æ –¥–µ–Ω–µ–≥.'
    ],
    scores: { '–∞': 3, '–±': 2, '–≤': 1 }
  }
];

function calculateScore(answers) {
  let total = 0;
  answers.forEach((answer, idx) => {
    if (answer && quizData[idx]) {
      const firstChar = answer.charAt(0).toLowerCase();
      total += quizData[idx].scores[firstChar] || 0;
    }
  });
  return total;
}

function getVerdict(score) {
  if (score >= 7 && score <= 9) {
    return {
      title: '–í–µ—Ä–¥–∏–∫—Ç 1: ¬´–ë—É–¥—É—â–∏–π –ü—Ä–æ—Ñ–∏¬ª (7-9 –±–∞–ª–ª–æ–≤)',
      subtitle: '–¢—ã —Å –æ—á–µ–Ω—å –±–æ–ª—å—à–æ–π –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å—é —Å–º–æ–∂–µ—à—å –æ—Å–≤–æ–∏—Ç—å –∫—É—Ä—Å. –ú—ã –æ—á–µ–Ω—å —Ä–∞–¥—ã, —á—Ç–æ –≤—Å—Ç—Ä–µ—Ç–∏–ª–∏ —Ç–∞–∫–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞!',
      content: `
        <p><strong>–¢–≤–æ–π –ø–æ—Ä—Ç—Ä–µ—Ç:</strong> –¢—ã –ª—é–±–æ–∑–Ω–∞—Ç–µ–ª–µ–Ω –¥–æ –≥–ª—É–±–∏–Ω—ã –¥—É—à–∏. –¢–µ–±–µ –Ω–µ –ø—Ä–æ—Å—Ç–æ ¬´–Ω–∞–¥–æ¬ª, —Ç–µ–±–µ <strong>–∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ</strong>. –¢—ã –Ω–µ –±–æ–∏—à—å—Å—è –∑–∞–ª–µ–∑—Ç—å –ø–æ–¥ –∫–∞–ø–æ—Ç, —á—Ç–æ–±—ã –ø–æ–Ω—è—Ç—å —Å—É—Ç—å, –∏ —Ç–≤–æ–π –º–æ–∑–≥ —Ç—Ä–µ–±—É–µ—Ç —Å–∫–æ—Ä–æ—Å—Ç–∏ –∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏. –¢—ã —Å–º–æ—Ç—Ä–∏—à—å –≤ –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω—É—é –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤—É ‚Äî —Å—Ç–∞—Ç—å –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª–æ–º, –∞ –Ω–µ –ø—Ä–æ—Å—Ç–æ ¬´–ø–æ–ª—É—á–∏—Ç—å —Å–∫–∏–ª–ª¬ª.</p>
        <p><strong>–ü–æ—á–µ–º—É –∫—É—Ä—Å —Ç–µ–±–µ –ø–æ–¥—Ö–æ–¥–∏—Ç:</strong> –ö—É—Ä—Å –¥–ª—è —Ç–µ–±—è ‚Äî —ç—Ç–æ –∫–ª—é—á –∫ –º–∏—Ä—É, –∫–æ—Ç–æ—Ä—ã–π —Ç—ã –∏—Å–∫—Ä–µ–Ω–Ω–µ —Ö–æ—á–µ—à—å –ø–æ–Ω—è—Ç—å. –¢—ã –±—É–¥–µ—à—å –Ω–µ ¬´–ø—Ä–æ—Ö–æ–¥–∏—Ç—å¬ª —É—Ä–æ–∫–∏, –∞ –ø–æ–≥—Ä—É–∂–∞—Ç—å—Å—è –≤ –Ω–∏—Ö, –∑–∞–¥–∞–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å—ã –∏ –ø–æ–ª—É—á–∞—Ç—å –Ω–∞—Å—Ç–æ—è—â–µ–µ —É–¥–æ–≤–æ–ª—å—Å—Ç–≤–∏–µ –æ—Ç —Ç–æ–≥–æ, –∫–∞–∫ —Å–∫–ª–∞–¥—ã–≤–∞–µ—Ç—Å—è –æ–±—â–∞—è –∫–∞—Ä—Ç–∏–Ω–∞. –¢—ã ‚Äî –∏–¥–µ–∞–ª—å–Ω—ã–π —Å—Ç—É–¥–µ–Ω—Ç.</p>
      `
    };
  } else if (score >= 5 && score <= 6) {
    return {
      title: '–í–µ—Ä–¥–∏–∫—Ç 2: ¬´–ú–æ—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å¬ª (5-6 –±–∞–ª–ª–æ–≤)',
      subtitle: '–¢–µ–±–µ –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç –ø—Ä–∏–ª–æ–∂–∏—Ç—å —Å—Ä–µ–¥–Ω–∏–µ —É—Å–∏–ª–∏—è, –∏ –º—ã —Å—á–∏—Ç–∞–µ–º, —á—Ç–æ —Ç—ã —Å–º–æ–∂–µ—à—å –æ—Å–≤–æ–∏—Ç—å –∫—É—Ä—Å –ø–æ–ª–Ω–æ—Å—Ç—å—é.',
      content: `
        <p><strong>–¢–≤–æ–π –ø–æ—Ä—Ç—Ä–µ—Ç:</strong> –¢—ã –ø—Ä–∞–≥–º–∞—Ç–∏—á–µ–Ω –∏ –∞–º–±–∏—Ü–∏–æ–∑–µ–Ω. –î–µ–Ω—å–≥–∏ –∏ –∫–∞—Ä—å–µ—Ä–∞ ‚Äî —Å–∏–ª—å–Ω—ã–µ –º–æ—Ç–∏–≤–∞—Ç–æ—Ä—ã. –¢—ã –≥–æ—Ç–æ–≤ –±—Ä–∞—Ç—å—Å—è –∑–∞ —Å–ª–æ–∂–Ω–æ–µ, –Ω–æ —Ç–≤–æ–π —ç–Ω—Ç—É–∑–∏–∞–∑–º –º–æ–∂–µ—Ç —É–≥–∞—Å–Ω—É—Ç—å, –µ—Å–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–µ –ø—Ä–∏—Ö–æ–¥–∏—Ç –±—ã—Å—Ç—Ä–æ. –¢—ã –º–æ–∂–µ—à—å –Ω–∞—á–∞—Ç—å —Ä–∞–∑–±–∏—Ä–∞—Ç—å –¥–≤–∏–≥–∞—Ç–µ–ª—å, –Ω–æ, —Å—Ç–æ–ª–∫–Ω—É–≤—à–∏—Å—å —Å —Ç—Ä—É–¥–Ω–æ—Å—Ç—è–º–∏, –æ—Ç—Å—Ç—É–ø–∏—Ç—å.</p>
        <p><strong>–ü–æ—á–µ–º—É —Ç–µ–±–µ –Ω—É–∂–Ω–æ –ø–æ–¥—É–º–∞—Ç—å:</strong> –¢–µ–±–µ –º–æ–∂–µ—Ç –Ω–µ —Ö–≤–∞—Ç–∏—Ç—å —Ç–æ–≥–æ —Å–∞–º–æ–≥–æ ¬´–∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ¬ª –∑–∞–¥–æ—Ä–∞, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–º–æ–≥–∞–µ—Ç –ø—Ä–æ–±–∏–≤–∞—Ç—å—Å—è —á–µ—Ä–µ–∑ —Å–ª–æ–∂–Ω—ã–µ —Ç–µ–º—ã. –¢–≤–æ—è —É—Å–ø–µ—à–Ω–æ—Å—Ç—å –±—É–¥–µ—Ç –Ω–∞–ø—Ä—è–º—É—é –∑–∞–≤–∏—Å–µ—Ç—å –æ—Ç —Ç–≤–æ–µ–π —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ <strong>—Å–æ–∑–¥–∞—Ç—å —Å–µ–±–µ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—É</strong>, –∫–æ–≥–¥–∞ –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä–µ—Å –æ—Å–ª–∞–±–Ω–µ—Ç. –ï—Å–ª–∏ –≥–æ—Ç–æ–≤ –∫ —ç—Ç–æ–º—É ‚Äî –¥–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</p>
      `
    };
  } else {
    return {
      title: '–í–µ—Ä–¥–∏–∫—Ç 3: ¬´–ò—Å–∫–∞—Ç–µ–ª—å –õ—ë–≥–∫–∏—Ö –ü—É—Ç–µ–π¬ª (3-4 –±–∞–ª–ª–∞)',
      subtitle: '–¢–µ–±–µ –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç –ø—Ä–∏–ª–æ–∂–∏—Ç—å —Å–≤–µ—Ä—Ö—É—Å–∏–ª–∏—è, —á—Ç–æ–±—ã –æ—Å–≤–æ–∏—Ç—å –∫—É—Ä—Å. –•–æ—Ä–æ—à–æ –ø–æ–¥—É–º–∞–π –ø–µ—Ä–µ–¥ –ø–æ–∫—É–ø–∫–æ–π: –≥–æ—Ç–æ–≤ –ª–∏ —Ç—ã –Ω–∞–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ –æ–±—É—á–µ–Ω–∏–µ —Å–≤–æ–π —Ñ–æ–∫—É—Å –∏ –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—é?',
      content: `
        <p><strong>–¢–≤–æ–π –ø–æ—Ä—Ç—Ä–µ—Ç:</strong> –¢—ã –Ω–∞—Ö–æ–¥–∏—à—å—Å—è –≤ –ø–æ–∏—Å–∫–µ ¬´–≤–æ–ª—à–µ–±–Ω–æ–π —Ç–∞–±–ª–µ—Ç–∫–∏¬ª. –¢—ã —Ö–æ—á–µ—à—å –ø–µ—Ä–µ–º–µ–Ω, –Ω–æ –Ω–µ –≥–æ—Ç–æ–≤ –≥–ª—É–±–æ–∫–æ –ø–æ–≥—Ä—É–∂–∞—Ç—å—Å—è. –¢—ã –ª–µ–≥–∫–æ –æ—Ç–≤–ª–µ–∫–∞–µ—à—å—Å—è, –∏ —Ç–≤–æ—è –º–æ—Ç–∏–≤–∞—Ü–∏—è –æ—á–µ–Ω—å —Ö—Ä—É–ø–∫–∞—è ‚Äî –æ–Ω–∞ –¥–µ—Ä–∂–∏—Ç—Å—è –Ω–∞ –≤–Ω–µ—à–Ω–∏—Ö —Ñ–∞–∫—Ç–æ—Ä–∞—Ö (–æ–±–µ—â–∞–Ω–∏—è—Ö, —Ö–∞–π–ø–µ), –∞ –Ω–µ –Ω–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–º –∏–Ω—Ç–µ—Ä–µ—Å–µ.</p>
        <p><strong>–ü–æ—á–µ–º—É –∫—É–ø–∏—Ç—å AiM-–∫—É—Ä—Å - —ç—Ç–æ —Ä–∏—Å–∫:</strong> –ú–∞—à–∏–Ω–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ, –¥–∞–∂–µ –±–µ–∑ —É–≥–ª—É–±–ª–µ–Ω–Ω–æ–π –º–∞—Ç–µ–º–∞—Ç–∏–∫–∏, —Ç—Ä–µ–±—É–µ—Ç —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞ –∏ —É–ø–æ—Ä—Å—Ç–≤–∞. –¢—ã —Ä–∏—Å–∫—É–µ—à—å –±—ã—Å—Ç—Ä–æ —Ä–∞–∑–æ—á–∞—Ä–æ–≤–∞—Ç—å—Å—è, –ø–æ—Ç–æ–º—É —á—Ç–æ —Ç–µ–±–µ –±—É–¥–µ—Ç ¬´—Å–∫—É—á–Ω–æ¬ª –∏–ª–∏ ¬´—Å–ª–æ–∂–Ω–æ¬ª, –∏ —Ç—ã –±—Ä–æ—Å–∏—à—å –æ–±—É—á–µ–Ω–∏–µ, —Ç–∞–∫ –∏ –Ω–µ –¥–æ–π–¥—è –¥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞. –ü–æ–∫—É–ø–∞—Ç—å –∫—É—Ä—Å —Å—Ç–æ–∏—Ç, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ç—ã –≥–æ—Ç–æ–≤ <strong>–∫–∞—Ä–¥–∏–Ω–∞–ª—å–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å —Å–≤–æ–π –ø–æ–¥—Ö–æ–¥</strong> –∏ —Å–µ—Ä—å–µ–∑–Ω–æ —Å–∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è.</p>
      `
    };
  }
}

function renderStep(container, stepIndex, answers, onDone) {
  container.innerHTML = '';
  if (stepIndex >= quizData.length) {
    const score = calculateScore(answers);
    const verdict = getVerdict(score);
    const done = document.createElement('div');
    done.className = 'verdict';
    done.innerHTML = `
      <h3>${verdict.title}</h3>
      <p style="font-weight: bold; margin-top: 10px;">${verdict.subtitle}</p>
      <div class="verdict-content">
        ${verdict.content}
      </div>
      <p style="margin-top: 20px; text-align: center;">–í–∞—à —Ä–µ–∑—É–ª—å—Ç–∞—Ç: ${score} –±–∞–ª–ª–æ–≤</p>
      <div class="answers" style="margin-top: 20px;">
        <button id="buyFull" class="right" style="background-color: #E83141;">–ö—É–ø–∏—Ç—å –ø–æ–ª–Ω—É—é –≤–µ—Ä—Å–∏—é</button>
      </div>
    `;
    container.appendChild(done);
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏—Ç–æ–≥–æ–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    sendProgress('final_score', score.toString());
    sendProgress('final_verdict', verdict.title);
    
    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–ö—É–ø–∏—Ç—å –ø–æ–ª–Ω—É—é –≤–µ—Ä—Å–∏—é"
    const buyBtn = document.getElementById('buyFull');
    if (buyBtn) {
      buyBtn.addEventListener('click', () => {
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ü–µ–ª—å go_to_bot –≤ –Ø–Ω–¥–µ–∫—Å –ú–µ—Ç—Ä–∏–∫—É
        if (window.ym && typeof window.ym === 'function') {
          try {
            window.ym(window.YANDEX_METRIKA_ID, 'reachGoal', 'go_to_bot');
          } catch (e) {
            console.error('Yandex Metrika error:', e);
          }
        }
        window.location.href = 'https://t.me/AiM_Pay_Bot';
      });
    }
    return;
  }

  const item = quizData[stepIndex];
  const wrap = document.createElement('div');
  wrap.className = 'question';

  const title = document.createElement('h3');
  title.innerHTML = item.title;
  wrap.appendChild(title);

  const body = document.createElement('div');
  const next = document.createElement('button');
  next.textContent = '–î–∞–ª–µ–µ ‚Üí';
  next.classList.add("right");
  next.disabled = !answers[stepIndex];
  next.addEventListener('click', () => onDone());

  if (item.type === 'choice') {
    const btns = document.createElement('div');
    btns.className = 'answers';
    const currentAnswer = answers[stepIndex] || savedAnswers[`final_q${stepIndex + 1}`];
    
    item.options.forEach(opt => {
      const b = document.createElement('button');
      b.innerHTML = opt;
      b.classList.add("ans")
      if (currentAnswer === opt) {
        b.classList.add('selectedd');
      }
      b.addEventListener('click', () => {
        // –†–∞–∑—Ä–µ—à–∞–µ–º –∏–∑–º–µ–Ω–∏—Ç—å –≤—ã–±–æ—Ä
        btns.querySelectorAll('button').forEach(x => x.classList.remove('selectedd'));
        b.classList.add('selectedd');
        answers[stepIndex] = opt;
        next.disabled = false;
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç —Å—Ä–∞–∑—É
        sendProgress(`final_q${stepIndex + 1}`, opt);
      });
      btns.appendChild(b);
    });
    body.appendChild(btns);
  }

  wrap.appendChild(body);
  const footer = document.createElement('div');
  footer.className = 'footer';
  footer.appendChild(next);
  wrap.appendChild(footer);
  container.appendChild(wrap);
}

(async function init() {
  await loadSavedAnswers();
  const root = document.getElementById('quiz');
  let step = 0;
  const answers = [];
  
  // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –≤ –º–∞—Å—Å–∏–≤
  quizData.forEach((_, idx) => {
    const saved = savedAnswers[`final_q${idx + 1}`];
    if (saved) {
      answers[idx] = saved;
    }
  });
  
  const next = () => {
    step += 1;
    renderStep(root, step, answers, next);
  };
  renderStep(root, step, answers, next);
})();


